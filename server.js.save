/** Autor: Adrián Arévalo Aguirre**/

var port = 8000;
var app = require('http').createServer(handler).listen(port),
  io = require('socket.io').listen(app),
  fs = require('fs'),
  sqlite3=require('sqlite3').verbose();
  var db= new sqlite3.Database('database.sqlite3');
  var connectCounter = 0;

//Si todo va bien al abrir el navegador, cargaremos el archivo index.html
function handler(req, res) {
	fs.readFile(__dirname+'/index.html', function(err, data) {
		if (err) {
      //Si hay error, mandaremos un mensaje de error 500
			console.log(err);
			res.writeHead(500);
			return res.end('Error loading index.html');
		}
		res.writeHead(200);
		res.end(data);
	});
}

//Cuando abramos el navegador estableceremos una conexión con socket.io.
//Cada X segundos mandaremos a la gráfica un nuevo valor. 

io.sockets.on('connection', function(socket) {
  var address = socket.handshake.address;

  console.log("New connection from " + address.address + ":" + address.port);
  connectCounter++; 
  console.log("NUMBER OF CONNECTIONS++: "+connectCounter);
 
 socket.on('disconnect', function() {
  connectCounter--;
  console.log("NUMBER OF CONNECTIONS--: "+connectCounter);
 });

// Funcion de precarga de los datos almacenados
 db.all('SELECT Referencia FROM Sensores', function (err,refs) {
    if(err){
       console.log('exec error: ' + err);
    }else{ //cargamos los sensores
	for(var i=0, l=refs.length; i<l;i++){
	var r=refs[i].Referencia;
	 db.all("SELECT  Valor, Fecha, Hora FROM Medidas WHERE Referencia='" + r + "'" , function ( err2,rows) {
          if(err) {
            console.log('exec error: ' + err2);
          }else {
	    console.log(rows);
 	      for (var j=0,l=rows.length;i<l;i++)
              var datos;
              var ref=rows[j].Referencia
          }
         }
        })  
      }
  }
})
});
