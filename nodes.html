<!--
    Autor: Adrián Arévalo Aguirre
-->
<html class="no-js" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
        DOMOLabo B105
    </title>
  
    <!-- Importo el módulo socket.io que tengo en el proyecto -->
  <script src="/socket.io/socket.io.js"></script>
  
    <!-- jQuery y DataTables -->
  <script type="text/javascript" language="javascript" src="//code.jquery.com/jquery-1.11.1.min.js"></script>
  <script type="text/javascript" language="javascript" src="//cdn.datatables.net/1.10.7/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" language="javascript" src="//cdn.datatables.net/tabletools/2.2.4/js/dataTables.tableTools.min.js"></script>
  
  <!-- CSS -->
  <link rel="stylesheet" type="text/css" href="//netdna.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/tabletools/2.2.4/css/dataTables.tableTools.css">
  <link rel="stylesheet" type="text/css" href="//cdn.datatables.net/plug-ins/1.10.7/integration/bootstrap/3/dataTables.bootstrap.css">
  <link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.4.5/css/bootstrapValidator.min.css"/>

  <!-- Latest compiled and minified JavaScript --> 
  <script type="text/javascript" language="javascript" src="//netdna.bootstrapcdn.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
  <script type="text/javascript" language="javascript" src="//cdn.datatables.net/plug-ins/1.10.7/integration/bootstrap/3/dataTables.bootstrap.js"></script>
  <script type="text/javascript" language="javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.4.5/js/bootstrapValidator.min.js"></script>

</head>

<body>

<div class="container">

  <!--Pannel Heading-->
    <div class="row marketing">
      <div class="col-lg-12">
        <div class="panel panel-primary" style="width:100%;">
          <div class="panel-heading" >Panel Informacion Sensores B105</div>
          <div class="panel-body">
	   <div class="col-lg-6">
            <p>Here you can see the general info of the sensors availabe,add, modify and delete sensors of the Domotics system.</p>
           </div>
	   <div class="col-lg-6">
	    <div class="btn-group pull-right">
             <a href="/" class="btn btn-primary btn-sm">Medidas</a>
             <button type="button" id="buttonResAP" class="btn btn-info btn-sm ">
              <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>Reset AP
             </button>
	    </div>
           </div>
          </div>
         </div>
        </div>
       </div>
    
  <!--Botones y formulario Set--> 
  <div class="row-markering">
   <div class="col-lg-5" style="padding-button: 15px;">
    <div class="btn-group has-error" role="group">
     <button type="button" id="buttonReleED" class="btn btn-success">
      <span class="glyphicon glyphicon-off" aria-hidden="true"></span>Relé
     </button>
     <button type="button" id="buttonLeds" class="btn btn-success">
      <span class="glyphicon glyphicon-off" aria-hidden="true"></span>Leds
     </button>
     <button type="button" id="buttonResED" class="btn btn-info">
      <span class="glyphicon glyphicon-wrench" aria-hidden="true"></span>Reset ED
     </button>
     <button type="button" id="ButtonTimer" class="btn btn-warning">
      <span class="glyphicon glyphicon-time" aria-hidden="true"></span>Set Timer
     </button>
     <button type="button" id="buttonDel" class="btn btn-danger">
      <span class="glyphicon glyphicon-trash" aria-hidden="true"></span>Eliminar
     </button>
    </div>
    <div class="row-markering">
      <span class="alert alert-warning" id="SelMessage" style="display:none;">Primero hay que seleccionar un nodo de la tabla.</span>
      <span class="alert alert-warning" id="ReleMessage" style="display:none;">El nodo seleccionado no permite el control de rele.</span>
    </div>
   </div>

   <div class="col-lg-7">
    <form id="set-form">
     <div class="col-lg-4" style="padding-top: 15px;">
     <div class="checkbox">
       <label><input type="checkbox" id="CheckMedidas" name="checkM"> Eliminar medidas</label>
      <div class="alert alert-warning" id="MedMessage" style="display:none;">Se eliminaran las medidas del nodo de la BD.</div>
      </div>
    </div>
     <div class="col-lg-4">
     <div class="form-group">
       <label for="inputTsleep" class="col-lg-4 control-label">TSleep</label>
       <input type="number" class="form-control" id="inputTsleep" name="iTsleep" placeholder="Tsleep in ms">
       <span class="help-block" id="TSMessage"></span>
     </div>
     </div>
     <div class="col-lg-4">
     <div class="form-group">
       <label for="inputTwake" class="col-lg-4 control-label">TWake</label>
        <input type="number" class="form-control" id="inputTwake" name="iTwake" placeholder="TWake in ms">
        <span class="help-block" id="TWMessage"></span>
     </div>
     </div>   
    </form>
   </div>
  </div>
  
   <!--Tabla de Sensores-->
  <div class="row-markering">
   <table id= "sensorTable" class="table table-hover" style="text-align:center;" data-click-to-select="true">
        <thead>
            <tr>
                <th class="text-center">Id_Nodo</th>
                <th class="text-center">Tipos</th>
                <th class="text-center">Localizacion</th>
                <th class="text-center">Bateria</th>
                <th class="text-center">Id_red</th>
                <th class="text-center"></th>
            </tr>
        </thead>
        <tbody></tbody>
       </table>

  <!--Formulario de Sensores-->
     <form id="sensor-form">
        <div class="col-lg-6">
         <div class="form-group">
           <label for="inputId" class="col-lg-3 control-label">Id_Nodo</label>
             <input type="number" class="form-control" id="inputId" name="iId" placeholder="Identif.">
             <span class="help-block" id="idMessage"></span>
         </div>
         <div class="form-group">
	   <label for="inputLoc" class="col-lg-3 control-label">Localizacion</label>
             <input type="number" class="form-control" id="inputLoc" name="iLoc" placeholder="Localiz.">
	     <span class="help-block" id="locMessage"></span> 
      	 </div>
       </div>
       <div class="col-lg-6">
        <div class="form-group">
          <label class="checkbox-inline">
            <input type="checkbox" id="CheckTemp" name="checkT" value="Temp">Temp
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="CheckPres" name="checkT"  value="Pres">Pres
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="CheckLum" name="checkT" value="Lum">Lum
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="CheckBat" name="checkT" value="Bat">Bat
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="CheckCons" name="checkT" value="Cons">Cons
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="CheckAtm" name="checkT" value="Atm">Atm 
          </label>
          <label class="checkbox-inline">
            <input type="checkbox" id="CheckHum" name="checkT" value="Hum">Hum 
          </label>
          <span class="help-block" id="checkMessage"></span>
        </div>
          <div class="col-lg-offset-2 col-lg-10" style="padding-top: 15px;">
              <button type="button" class="btn btn-primary" id= "buttonSave">Guardar</button>
              <button type="button" class="btn btn-default" id="buttonReset">Reset</button>
            </div>
         </form>
       </div>
    </div>    
    
  <!-- Se creara la tabla dinamicamente con Javascript e Interfaces DOM -->
  <script>
    // Creo un WebSocket.
     var socket = io.connect('http://'+ location.host);
     // console.log(location.host);
   // Cargo la tablaSensores
   $(document).ready(function(){
     var table = $('#sensorTable').DataTable( {
      "sRowSelected": "single",
      "sDom": 'T<"clear">lfrtip',
      //Resalta los nodos con bateria baja, y añade estado leds y relé
      "createdRow": function ( row, data, index ) {
        if ( 2.5 > data[3] ) {
         $('td', row).eq(3).append('<span class="glyphicon glyphicon-warning-sign" style="color:#CC9900;"></span>');
        }
	$('td', row).eq(5).append('<span class="glyphicon glyphicon-ok" style="color:#4AA02C;display:none;"></span>')	
	                  .append('<span class="glyphicon glyphicon-off" style="color:#C11B17;display:none;"></span>');	
      },
      "oTableTools": {
      "aButtons": ["print"]
      },
     });

     //Validacion del Formulario sensores
     $('#sensor-form').bootstrapValidator({
       message: 'This value is not valid',
       feedbackIcons: {
       valid: 'glyphicon glyphicon-ok',
       invalid: 'glyphicon glyphicon-remove',
       validating: 'glyphicon glyphicon-refresh'
       },
       fields: {
        iId: {
	       container: '#idMessage',
	       validators: {
	       notEmpty: {message: "Id_nodo is required"},
	       between: {
            min: 0,
            max: 99,
            message: 'The Id_nodo must be between 0 and 99'
         }
         } 
        }, 
        iLoc: {
         container: '#locMessage',
         validators: {
	       notEmpty: {message: "Loc is required"},
         between: {
          min: 0,
          max: 99,
          message: 'The Location must be between 0 and 99'
         }
         }
        },
        checkT: {
          container: '#checkMessage',
          validators: {
          choice: {
	          min: 1,	
            message: 'The type of sensors is required'
	        }
          }
         }
       } 
      });

     //Validacion del Formulario Set  
     $('#set-form').bootstrapValidator({
       message: 'This value is not valid',
       feedbackIcons: {
       valid: 'glyphicon glyphicon-ok',
       invalid: 'glyphicon glyphicon-remove',
       validating: 'glyphicon glyphicon-refresh'
       },
       fields: {
        iTsleep: {
         container: '#TSMessage',
         validators: {
         notEmpty: {message: "Tsleep is required"},
         between: {
           min: 0,
           max: 60000,
           message: 'The Tsleep time must be between 0 and 3600s'
         }
        } 
       }, 
        iTwake: {
          container: '#TWMessage',
          validators: {
          notEmpty: {message: "Twake is required"},
          between: {
            min: 0,
            max: 1000,
            message: 'The TWake time must be between 0 and 3600s'
            }
          }
        }
      } 
     });

     //Carga de la Tabla
     socket.on('SLoad', function (data) {
       table.rows.add(data);
       table.draw();
     });

    //Seleccion de filas
    $('#sensorTable tbody').on( 'click', 'tr', function () {
        if ( $(this).hasClass('selected') ) {
            $(this).removeClass('selected');
            $(this).removeClass('warning');
        }
        else {
            table.$('tr.selected').removeClass('warning');
            table.$('tr.selected').removeClass('selected');
            $(this).addClass('selected');
            $(this).addClass('warning');
        }
    });

    //Boton de reset AP
     $('#buttonResAP').click( function () {
        socket.emit('SReset',0);
     });

     //Boton de borrado filas tabla
     $('#buttonDel').click( function () {
        var rowData = table.row('.warning').data();
	if(typeof rowData === 'undefined'){
          $('#SelMessage').show();
        }else{
 	var flag = $('#CheckMedidas').is(':checked');
        //Borramos el sensor y/o las medidas del servidor
        socket.emit('SDelete',rowData[0],flag);
       //Lo borramos de la tabla
        table.row('.warning').remove().draw( false );
        //draw false para quedarse en la misma pagina
        $('#SelMessage').hide();
       }
     });

     //Warning Medidas
     $('#CheckMedidas').click( function () {
      if($(this).is(':checked')){
        $(this).closest('.checkbox').addClass('has-warning');
	$('#MedMessage').show();
      }
      else if($(this).is(":not(:checked)")){
        $(this).closest('.checkbox').removeClass('has-warning');
        $('#MedMessage').hide();
      }
     });

     //Boton de Rele ED
     $('#buttonReleED').click( function () {
        var rowData = table.row('.warning').data();
        if(typeof rowData === 'undefined'){
          $('#SelMessage').show();
        }else{
          $('#SelMessage').hide();
	  if(table.$('tr.selected').find("td").eq(1).text().indexOf("Cons") != -1){
	  $('#ReleMessage').hide();
	   var f=table.$('tr.selected').find("td").eq(5).children('span:last').css('display');
	   if(f=='none' ){
	    var flag=1; //ON
	    table.$('tr.selected').find("td").eq(5).children('span:last').show();
	   }
	   else{
	    var flag=0; //OFF
	    table.$('tr.selected').find("td").eq(5).children('span:last').hide();
	   }
	   socket.emit('SRele',rowData[4],flag);
	  }
	  else{$('#ReleMessage').show();}
          table.$('tr.selected').removeClass('warning');
          table.$('tr.selected').removeClass('selected');
        }
      });

     //Boton de Leds ED
     $('#buttonLeds').click( function () {
       var rowData = table.row('.warning').data();
        if(typeof rowData === 'undefined'){
          $('#SelMessage').show();
        }else{
          $('#SelMessage').hide();
           var f=table.$('tr.selected').find("td").eq(5).children('span:first').css('display');
           if(f=='none' ){
            var flag=1; //ON
            table.$('tr.selected').find("td").eq(5).children('span:first').show();
           }
           else{
            var flag=0; //OFF
            table.$('tr.selected').find("td").eq(5).children('span:first').hide();
           }
          socket.emit('SLeds',rowData[4],flag);
          table.$('tr.selected').removeClass('warning');
          table.$('tr.selected').removeClass('selected');
        }
      });

     //Boton de reset ED
     $('#buttonResED').click( function () {
        var rowData = table.row('.warning').data();
        if(typeof rowData === 'undefined'){
	  $('#SelMessage').show();
	}else{
	socket.emit('SReset',rowData[4]);
        table.$('tr.selected').removeClass('warning');
        table.$('tr.selected').removeClass('selected');
           $('#SelMessage').hide();
        }
      });

     //Boton set TimerWeakup y TimerSleep
     $('#ButtonTimer').click( function () {
      //Validamos el formulario
      $("#set-form").data('bootstrapValidator').validate();
      if($("#set-form").data('bootstrapValidator').isValid()){
        var rowData = table.row('.warning').data();
        if(typeof rowData === 'undefined'){
          $('#SelMessage').show();
        }else{
         var id_nodo = $('#inputId').val();
         var rowData = table.row('.warning').data();
         var Tsleep =  $('#inputTsleep').val();
         var TWake = $('#inputTwake').val();
         socket.emit('STimer',rowData[4],Tsleep,TWake);
         table.$('tr.selected').removeClass('warning');
         table.$('tr.selected').removeClass('selected');
         $('#SelMessage').hide();
	 }
      }
      });

     //Boton de guardado de formulario
     $("#buttonSave").click(function(){
      //Validamos el formulario
      $("#sensor-form").data('bootstrapValidator').validate();
      if($("#sensor-form").data('bootstrapValidator').isValid()){
      	var id_nodo = $('#inputId').val();
      	var loc = $('#inputLoc').val();
      	tipos="";
      	$("input:checkbox:checked").each(function() {
           var tipo = $(this).val();
      	   tipos=tipos+tipo+", ";
     	  });
      	//Lo guardamos en el servidor
      	socket.emit('SNew',[id_nodo,tipos,loc,0]);
      	//Lo guardamos en la tabla
      	table.row.add([id_nodo,tipos,loc,0,-1,null]);
      	table.draw();
      }        
     });

     //Boton de reset de formulario
     $("#buttonReset").click(function(){
      $('#sensor-form').each (function(){
       this.reset();
      });
     $('#sensor-form').bootstrapValidator('resetForm',true);
     });
  });
  </script>
  </body>
</html>
